# 一、Prometheus安装及配置

1、下载及解压安装包
```bash
cd /usr/local/src/

export VER="2.13.1"
wget https://github.com/prometheus/prometheus/releases/download/v${VER}/prometheus-${VER}.linux-amd64.tar.gz

mkdir -p /data0/prometheus 
groupadd prometheus
useradd -g prometheus prometheus -d /data0/prometheus
 
tar -xvf prometheus-${VER}.linux-amd64.tar.gz
cd /usr/local/src/
mv prometheus-${VER}.linux-amd64/* /data0/prometheus/
 
cd /data0/prometheus/
mkdir -p {data,config,logs,bin} 
mv prometheus promtool bin/
mv prometheus.yml config/
 
chown -R prometheus.prometheus /data0/prometheus
```
2 、设置环境变量
```bash
vim /etc/profile

PATH=/data0/prometheus/bin:$PATH:$HOME/bin

source /etc/profile
```

3、检查配置文件
```bash
promtool check config /data0/prometheus/config/prometheus.yml

Checking /data0/prometheus/config/prometheus.yml
  SUCCESS: 0 rule files found
```

4、创建prometheus.service 的 systemd unit 文件

- 4.1、常规服务

```bash
sudo tee /etc/systemd/system/prometheus.service <<-'EOF'
[Unit]
Description=Prometheus
Documentation=https://prometheus.io/
After=network.target
 
[Service]
Type=simple
User=prometheus
ExecStart=/data0/prometheus/bin/prometheus --config.file=/data0/prometheus/config/prometheus.yml --storage.tsdb.path=/data0/prometheus/data --storage.tsdb.retention=60d
Restart=on-failure
 
[Install]
WantedBy=multi-user.target
EOF

systemctl enable prometheus.service
systemctl restart prometheus.service
systemctl status prometheus.service
```

- 4.2、使用supervisor管理prometheus_server
```bash
yum install -y epel-release supervisor
systemctl enable supervisord
systemctl restart supervisord

sudo tee /etc/supervisord.d/prometheus.ini<<-"EOF"
[program:prometheus]
# 启动程序的命令;
command = /data0/prometheus/bin/prometheus --config.file=/data0/prometheus/config/prometheus.yml --storage.tsdb.path=/data0/prometheus/data --storage.tsdb.retention=60d
# 在supervisord启动的时候也自动启动;
autostart = true
# 程序异常退出后自动重启;
autorestart = true
# 启动5秒后没有异常退出，就当作已经正常启动了;
startsecs = 5
# 启动失败自动重试次数，默认是3;
startretries = 3
# 启动程序的用户;
user = prometheus
# 把stderr重定向到stdout，默认false;
redirect_stderr = true
# 标准日志输出;
stdout_logfile=/data0/prometheus/logs/out-prometheus.log
# 错误日志输出;
stderr_logfile=/data0/prometheus/logs/err-prometheus.log
# 标准日志文件大小，默认50MB;
stdout_logfile_maxbytes = 20MB
# 标准日志文件备份数;
stdout_logfile_backups = 20
EOF

systemctl daemon-reload
systemctl restart supervisord
supervisorctl restart prometheus
supervisorctl status
```

5、prometheus.yml配置文件
```bash
#创建Alertmanager告警规则文件
mkdir -p /data0/prometheus/rules/
touch /data0/prometheus/rules/node_down.yml
touch /data0/prometheus/rules/memory_over.yml
touch /data0/prometheus/rules/disk_over.yml
touch /data0/prometheus/rules/cpu_over.yml

#prometheus配置文件
cat > /data0/prometheus/config/prometheus.yml << \EOF
# my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - 192.168.56.11:9093 # 这里修改为 alertmanagers 的地址                                              # alertmanager主机地址

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
# - "first_rules.yml"
# - "second_rules.yml"
  - "/data0/prometheus/rules/node_down.yml"                 # 实例存活报警规则文件
  - "/data0/prometheus/rules/memory_over.yml"               # 内存报警规则文件
  - "/data0/prometheus/rules/disk_over.yml"                 # 磁盘报警规则文件
  - "/data0/prometheus/rules/cpu_over.yml"                  # cpu报警规则文件

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['localhost:9090', 'localhost:9100']

  - job_name: 'GICHOST'
    file_sd_configs:
      - files: ['./hosts.json']  
      # 被监控的主机，可以通过static_configs罗列所有机器，这里通过file_sd_configs参数加载文件的形式读取
      # 被监控的主机，可以json或yaml格式书写，我这里以json格式书写，target里面写监控机器的ip，labels非必须，可以由你自己定
EOF

#file_sd_configs参数形式配置主机列表
cat > /data0/prometheus/config/hosts.json << \EOF
[
{
"targets": [
	"192.168.56.11:9100",
	"192.168.56.12:9100",
	"192.168.56.13:9100"
],
"labels": {
    "host": "server_node"
    }
},

{
"targets": [
	"192.168.56.14:9100",
	"192.168.56.15:9100",
	"192.168.56.16:9100"
],
"labels": {
	"service": "web_node"
    }
}
]
EOF

# 机器存活报警
cat > /data0/prometheus/rules/node_down.yml <<\EOF
groups:
- name: node存活报警规则
  rules:
  - alert: InstanceDown
    expr: up == 0
    for: 1m
    labels:
      user: prometheus
    annotations:
      summary: "Instance {{ $labels.instance }} down"
      description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minutes."
EOF
```
6、查看ui

Prometheus自带有简单的UI, http://192.168.56.11:9090/

```bash
http://192.168.56.11:9090/targets
http://192.168.56.11:9090/graph
```

# 二、node_exporter安装及配置

1、下载及解压安装包
```bash
cd /usr/local/src/

export VER="0.18.1"
wget https://github.com/prometheus/node_exporter/releases/download/v${VER}/node_exporter-${VER}.linux-amd64.tar.gz

mkdir -p /data0/prometheus 
groupadd prometheus
useradd -g prometheus prometheus -d /data0/prometheus
 
tar -xvf node_exporter-${VER}.linux-amd64.tar.gz
cd /usr/local/src/
mv node_exporter-${VER}.linux-amd64 /data0/prometheus/node_exporter
 
chown -R prometheus.prometheus /data0/prometheus
```

2、创建node_exporter.service的 systemd unit 文件

```bash
cat > /usr/lib/systemd/system/node_exporter.service <<EOF
[Unit]
Description=node_exporter
Documentation=https://prometheus.io/
After=network.target
 
[Service]
Type=simple
User=prometheus
ExecStart=/data0/prometheus/node_exporter/node_exporter
Restart=on-failure
 
[Install]
WantedBy=multi-user.target
EOF
```
ubuntu下创建服务

```bash
cat > /etc/systemd/system/node_exporter.service <<EOF
[Unit]
Description=node_exporter
Documentation=https://prometheus.io/
After=network.target
 
[Service]
Type=simple
User=prometheus
ExecStart=/data0/prometheus/node_exporter/node_exporter
Restart=on-failure
 
[Install]
WantedBy=multi-user.target
EOF
```

3、启动服务
```bash
systemctl daemon-reload
systemctl enable node_exporter.service
systemctl restart node_exporter.service
```

4、运行状态
```bash
systemctl status node_exporter.service
```

5、客户监控端数据汇报

访问：http://192.168.56.11:9100/metrics  查看从exporter具体能抓到的数据.如下：

# 三、Grafana安装及配置

1、下载及安装
```bash
cd /usr/local/src/

export VER="6.2.4"
wget https://dl.grafana.com/oss/release/grafana-${VER}-1.x86_64.rpm
yum localinstall -y grafana-${VER}-1.x86_64.rpm
```

2、启动服务
```bash
systemctl daemon-reload
systemctl enable grafana-server.service
systemctl restart grafana-server.service
```

3、访问WEB界面

默认账号/密码：admin/admin
http://192.168.56.11:3000


4、Grafana添加数据源
```bash
在登陆首页，点击"Configuration-Data Sources"按钮，跳转到添加数据源页面，配置如下：
Name: prometheus
Type: prometheus
URL: http://192.168.56.11:9090
Access: Server
取消Default的勾选，其余默认，点击"Add"，如下：

需要安装饼图的插件
grafana-cli plugins install grafana-piechart-panel
systemctl restart grafana-server.service

请确保安装后能正常添加饼图。

安装consul数据源插件
grafana-cli plugins install sbueringer-consul-datasource
systemctl restart grafana-server.service
```

# 四、替换grafana的dashboards

https://grafana.com/dashboards

```
https://grafana.com/dashboards/8919   基础监控

https://grafana.com/dashboards/7362   数据库监控
```

参考文档：

https://blog.csdn.net/xiegh2014/article/details/84936174   CentOS7.5 Prometheus2.5+Grafana5.4监控部署

https://www.cnblogs.com/smallSevens/p/7805842.html    Grafana+Prometheus打造全方位立体监控系统 

https://www.cnblogs.com/sfnz/p/6566951.html安装prometheus+grafana监控mysql redis kubernetes等 

https://blog.csdn.net/hzs33/article/details/86553259  prometheus+grafana监控mysql、canal服务器
